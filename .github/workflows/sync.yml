name: Generate Images Metadata JSON

on:
  push:
    paths:
      - "images/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required to get full git history for dates

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          npm install image-size

      - name: Generate metadata JSON
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const { execSync } = require("child_process");
          const sizeOf = require("image-size");

          const IMAGES_DIR = "images";
          const OUTPUT_FILE = "images-meta.json";

          if (!fs.existsSync(IMAGES_DIR)) {
            console.log(`Directory ${IMAGES_DIR} not found. Creating empty registry.`);
            fs.writeFileSync(OUTPUT_FILE, JSON.stringify({ images: [] }));
            process.exit(0);
          }

          function walk(dir) {
            let results = [];
            const list = fs.readdirSync(dir);
            for (const file of list) {
              const fullPath = path.join(dir, file);
              const stat = fs.statSync(fullPath);
              if (stat.isDirectory()) {
                results = results.concat(walk(fullPath));
              } else if (/\.(png|jpe?g|webp|bmp|tiff|svg)$/i.test(file)) {
                results.push(fullPath);
              }
            }
            return results;
          }

          function gitDate(file, first = false) {
            try {
              // %aI = author date, strict ISO 8601 format
              const cmd = first
                ? `git log --diff-filter=A --follow --format=%aI -- "${file}" | tail -1`
                : `git log -1 --format=%aI -- "${file}"`;
              const result = execSync(cmd).toString().trim();
              return result || new Date().toISOString(); 
            } catch {
              return new Date().toISOString();
            }
          }

          const files = walk(IMAGES_DIR);
          const data = files.map(file => {
            console.log(`Processing: ${file}`);
            const stat = fs.statSync(file);
            let dimensions = { width: 0, height: 0 };
            
            try {
              dimensions = sizeOf(file);
            } catch (e) {
              console.error(`Could not get dimensions for ${file}`);
            }

            let dpi = "unknown";
            let bitDepth = "unknown";

            try {
              // identify returns "resolution-x|bit-depth"
              const identify = execSync(
                `identify -format "%x|%z" "${file}"`
              ).toString().trim();
              const parts = identify.split("|");
              dpi = parts[0] || "unknown";
              bitDepth = parts[1] || "unknown";
            } catch (e) {
              // Silently fail for formats identify might struggle with
            }

            return {
              name: path.basename(file),
              path: file.replace(/\\/g, "/"),
              folder: path.dirname(file).replace(/\\/g, "/"),
              type: path.extname(file).replace(".", "").toLowerCase(),
              size_bytes: stat.size,
              size_formatted: {
                kb: +(stat.size / 1024).toFixed(2),
                mb: +(stat.size / (1024 * 1024)).toFixed(2)
              },
              dimensions: {
                width: dimensions.width,
                height: dimensions.height,
                string: `${dimensions.width}x${dimensions.height}`
              },
              dpi: dpi,
              bit_depth: bitDepth,
              dates: {
                added: gitDate(file, true),
                last_modified: gitDate(file)
              }
            };
          });

          const output = {
            generated_at: new Date().toISOString(),
            total_images: data.length,
            images: data
          };

          fs.writeFileSync(OUTPUT_FILE, JSON.stringify(output, null, 2));
          console.log(`Successfully generated ${OUTPUT_FILE}`);
          EOF

      - name: Commit and push JSON
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add images-meta.json
          # Only commit if there are changes
          git diff --quiet && git diff --staged --quiet || (git commit -m "chore: update images metadata [skip ci]" && git push)
