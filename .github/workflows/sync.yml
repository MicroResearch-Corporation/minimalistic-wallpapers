name: Build CDN Image Metadata

on:
  push:
    paths:
      - "images/**"
  workflow_dispatch:

permissions:
  contents: write

jobs:
  metadata:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout main
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install tools
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick
          npm install image-size

      - name: Generate metadata
        run: |
          node <<'EOF'
          const fs = require("fs");
          const path = require("path");
          const crypto = require("crypto");
          const { execSync } = require("child_process");
          const sizeOf = require("image-size");

          const ROOT = "images";
          const OUT = "images-meta.json";
          const allowed = /\.(png|jpe?g|webp|bmp|tiff)$/i;

          function walk(dir) {
            return fs.readdirSync(dir).flatMap(f => {
              const p = path.join(dir, f);
              return fs.statSync(p).isDirectory() ? walk(p) : p;
            }).filter(f => allowed.test(f));
          }

          function gitDate(file, first = false) {
            try {
              const cmd = first
                ? `git log --follow --diff-filter=A --format=%aI -- "${file}" | tail -1`
                : `git log -1 --format=%aI -- "${file}"`;
              return execSync(cmd).toString().trim().slice(0,10);
            } catch {
              return null;
            }
          }

          const files = walk(ROOT);
          const hashes = {};
          const images = [];

          for (const file of files) {
            const buf = fs.readFileSync(file);
            const hash = crypto.createHash("sha256").update(buf).digest("hex");

            const { width, height } = sizeOf(buf);
            const stat = fs.statSync(file);
            const ext = path.extname(file).slice(1).toLowerCase();
            const folder = file.split("/")[1] || "root";

            let dpi = "unknown", bit = "unknown";
            try {
              const r = execSync(`identify -format "%x|%z" "${file}"`)
                .toString().trim().split("|");
              dpi = r[0]; bit = r[1];
            } catch {}

            hashes[hash] = (hashes[hash] || 0) + 1;

            images.push({
              id: hash.slice(0, 8),
              name: path.basename(file),
              src: file.replace(/\\/g, "/"),
              folder,
              ext,

              w: width,
              h: height,
              ratio: `${width}:${height}`,

              dpi,
              bit,

              kb: +(stat.size / 1024).toFixed(2),
              mb: +(stat.size / 1048576).toFixed(2),

              hash,
              added: gitDate(file, true),
              updated: gitDate(file)
            });
          }

          const duplicates = Object.values(hashes).filter(v => v > 1).length;

          fs.writeFileSync(
            OUT,
            JSON.stringify({
              version: 1,
              generated_at: new Date().toISOString(),
              total: images.length,
              duplicates,
              images
            }, null, 2)
          );
          EOF

      - name: Push to output branch
        run: |
          git fetch origin
          git switch --orphan output || git switch output
          git rm -rf .
          git checkout origin/main -- images-meta.json
          git add images-meta.json
          git commit -m "CDN metadata update" || echo "No changes"
          git push -f origin output
